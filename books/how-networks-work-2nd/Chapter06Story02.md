# 02. 서버의 수신 동작 

### LAN 어댑터에서 수신 신호를 디지털 데이터로 변환한다

서버에 도착하는 패킷의 실체는 전기나 빛의 신호이며, 이것을 수신하는 동작은 클라이언트와 동일하다.  
수신 동작은 패킷의 신호를 LAN 어댑터에서 수신하고 디지털 데이터로 바꾸는 부분에서 시작된다.

패킷의 맨 마지막에 있는 프레임 체크 시퀀스(FCS)라는 오류 검사용 데이터를 이용하여 오류 유무를 검사한다.  
즉 수신하여 디지털 데이터로 되돌리는 것을 오류 검사의 계산식에 따라 계산하고, 패킷의 맨 끝에 있는 FCS 필드의 값과 비교하는 것이다.

FCS 가 일치하고 오류가 없는 것을 확인한 다음에는 맨 앞의 MAC 헤더에 있는 수신처 MAC 주소를 조사하여 패킷이 자신을 수신처로 하여 보낸 것인지 판단한다.  
이더넷의 기본 동작은 먼저 신호를 LAN 전체로 흘리고 해당자만 신호를 수신한다는 방법을 취한다.

디지털 데이터로 되돌린 것을 LAN 어댑터 내부의 버퍼 메모리에 저장한다.  
LAN 어댑터의 MAC 부분이 실행한다.

그 사이에 서버의 CPU 는 패킷의 도착을 감시하고 있는 것이 아니라 다른 일을 실행하고 있으므로 CPU 는 패킷을 알아차리지 못한다.  
따라서 수신 처리가 진행되지 않으므로 인터럽트라는 방법을 사용하여 LAN 어댑터에서 CPU 로 패킷의 도착을 알린다.

이 시점에서 CPU 는 실행하고 있던 작업을 중단하고 LAN 드라이버로 실행을 전환한다.  
LAN 드라이버가 동작하기 시작하여 LAN 어댑터의 버퍼 메모리에서 수신한 패킷을 추출한다.  
LAN 드라이버가 MAC 헤더로부터 프로토콜을 판단하여 프로토콜 스택에 패킷을 건네준다.  
IP 프로토콜인 경우 TCP/IP 의 프로토콜 스택을 호출하고 여기에 패킷을 건네주는 것이다.

### IP 담당 부분의 수신 동작

프로토콜 스택에 패킷이 전달되면 우선 IP 담당 부분이 동작하여 IP 헤더를 점검한다.  
이상이 없다면 IP 헤더의 프로토콜 번호 항목을 조사하여 TCP 담당 부분 또는 UDP 담당 부분에 패킷을 건네준다.

### TCP 담당 부분이 접속 패킷을 수신했을 때의 동작

패킷이 접속 동작의 패킷인 경우 TCP 담당 부분은 TCP 헤더의 `SYN` 의 컨트롤 비트를 확인하고 수신처 포트 번호를 조사한 후 해당하는 접속 대기 소켓을 복사하여 새 소켓을 작성한다.  
그 후 송신처의 IP 주소나 포트 번호 등을 기록한다.

### TCP 담당 부분이 데이터 패킷을 수신했을 때의 동작

데이터의 패킷을 수신한 경우 TCP 담당 부분은 도착한 패킷의 송신처 IP 주소, 송신처 포트 번호, 수신처 IP 주소, 송신처 포트 번호로부터 해당하는 소켓을 판단한다.  
데이터의 조각을 연결해서 수신 버퍼에 보관한 후 클라이언트에게 `ACK` 를 되돌려준다.

### TCP 담당 부분의 연결 끊기 동작

데이터 송∙수신이 끝나면 연결 끊기 동작에 들어간다.  
이때의 동작은 클라이언트와 동일하다.

TCP 프로토콜의 규칙에 따르면 연결 끊기 동작은 클라이언트와 서버 중 어느 쪽이 먼저 실행해도 상관없다.  
애플리케이션이 어디에서부터 연결 끊기 동작을 실행하는지 결정해야 한다.  
웹의 경우 HTTP 프로토콜의 버전에 따라 다르므로 HTTP 1.0 이라면 서버에서 연결 끊기 동작을 시작한다.