# 03. 웹 서버 소프트웨어가 리퀘스트 메시지의 의미를 해석하여 요구에 응한다 

### 조회의 URI 를 실제 파일명을 변환한다

웹 서버의 경우 `read` 에서 받은 데이터의 내용이 HTTP 요청 메시지가 된다.  
받은 요청 메시지에 기록되어 있는 내용에 따라 적절한 처리를 실행하여 응답 메시지를 만들고, `write` 를 통해 이것을 클라이언트에 반송한다는 형태로 작동한다.

요청 메시지에는 메소드라는 일종의 명령과 데이터 출처를 나타내는 URI 라는 파일의 경로명 같은 것이 쓰여있으며, 내용에 따라 데이터를 클라이언트에 반송한다.  
이 경우 메소드나 URI 의 내용에 따라 웹 서버 내부의 동작이 달라진다.

단순히 URI 에 기록되어 있는 경로명의 파일을 읽어오면 디스크의 파일에 전부 액세스할 수 있게 되므로 웹 서버의 디스크가 무방비 상태로 노출되어 위험하다.  

따라서 웹 서버에서 공개하는 디렉토리는 디스크의 실제 디렉토리가 아니라 가상으로 만든 디렉토리 구조에서의 경로명을 URI 에 써야 한다.  
그러므로 파일을 읽어올 때는 가상의 디렉토리와 실제 디렉토리의 대응 관계를 조사하고, 실제 디렉토리의 경로명으로 변환한 후 파일을 읽어 데이터를 반송한다.

URI 에 쓰여있는 경로명이 파일명을 생략한 형태인 경우에는 미리 설정한 파일명이 쓰여있는 것으로 간주한다.

파일명을 바꿔쓰는 규칙을 서버에 설정하고 규칙에 따라 파일명을 바꿔쓰고 나서 파일에 액세스하는 웹 서버 애플리케이션도 있다.  
URI 에 쓴 경로명이 설정되어 있던 패턴에 합치하면 경로명을 바꿔쓴 후 디스크에 액세스하는 것이다.  
어떤 이유로든지 웹 서버에서 디렉토리명이나 파일명을 변경했지만, 원래 URL 에서 그대로 액세스하려는 경우에는 이 기능이 편리하다.

### CGI 프로그램을 작동하는 경우

URI 에 쓴 파일의 내용이 HTML 문서나 화상 데이터인 경우에는 파일의 내용을 그대로 응답 메시지로 클라이언트에 반송한다.  
하지만 URI 에 쓰는 파일의 내용은 HTML 문서뿐만 아니라 프로그램 파일의 이름을 URI 에 쓸 수도 있다.  
이 경우에는 파일의 내용을 그대로 반송하지 않고 해당 프로그램을 작동시켜서 프로그램이 출력하는 데이터를 클라이언트에 반송한다.  
웹 서버에서 작동시키는 프로그램은 몇 가지 유형이 있고, 각 유형에 따라 구체적인 동작이 달라지지만, CGI 라는 타입의 프로그램은 다음과 같이 동작한다.

요청 메시지를 받은 웹 서버는 먼저 URI 의 부분에 쓰여있는 파일명을 조사하여 이것이 프로그램인지 판단한다.  
`.cgi`, `.php` 확장자를 등록해 두고 파일명의 확장자가 이것과 일치하면 프로그램으로 간주하는 것이다.

파일이 프로그램인 것을 알고 있으면 웹 서버는 이 프로그램을 작동시키도록 OS 에 의뢰한다.  
그리고 요청 메시지에서 데이터를 추출하여 작동시킨 프로그램에 건네준다.

작동시킨 프로그램이 받은 데이터를 처리하여 무언가의 출력 데이터를 웹 서버에 되돌려준다.  
출력 데이터는 보통 HTML 태그를 내장한 HTML 문서로 되어 있으므로 웹 서버는 이것을 그대로 응답 메시지로 클라이언트에 반송한다.

### 웹 서버로 수행하는 액세스 제어

요청 메시지의 내용에서 데이터 출처를 판단하고, 그곳에서 데이터를 얻어 클라이언트에 반송한다는 것이 웹 서버의 기본 동작이다.  
하지만 그 동작을 실행할 때 사전에 설정해 둔 조건에 해당하는지 조사하고, 조건에 해당하는 경우 그 동작을 금지하거나 조건에 해당하는 경우에만 동작을 실행한다는 기능도 있다.  

이와 같이 조건에 따라 액세스 동작 여부를 설정하는 기능을 액세스 제어라고 한다.  

웹 서버에서 설정하는 조건은 주로 다음의 세 가지이다.
1. 클라이언트 주소
2. 클라이언트 도메인명
3. 사용자명과 비밀번호

이 조건을 데이터 출처가 되는 파일이나 디렉토리와 대응해서 설정한다.  
클라이언트에서 요청 메시지를 받고 URI 에서 데이터 출처를 판단하면, 여기에 액세스 가능 여부의 조건이 설정되어 있는지 조사하고 액세스가 허가된 경우에만 파일을 읽거나 프로그램을 실행한다.

### 응답 메시지를 되돌려 보낸다

이렇게 해서 요청 메시지에 대해 적절하게 처리하고 처리가 완료되면 응답 메시지를 반송한다.  
이때의 개념은 최초에 클라이언트가 요청 메시지를 웹 서버에 보내는 동작과 동일하다.

먼저 웹 서버가 Socket 라이브러리의 `write` 를 호출하여 응답 메시지를 프로토콜 스택에 건네준다.  
이때 응답 메시지를 어디에 보내야 할지를 프로토콜 스택에 알려주어야 하는데, 통신 상대의 클라이언트를 직접 통지하는 것이 아니라 어느 소켓을 사용하여 통신하고 있는지를 나타내는 디스크립터를 통지하여 상대를 지정해야 한다.  
소켓에는 통신의 상태가 전부 기록되어 있고, 여기에 통신 상대의 정보도 있으므로 디스크립터만 통지하면 된다.

프로토콜 스택은 데이터를 한 개의 패킷에 들어가는 길이로 분할하고 헤더를 붙여서 패킷을 송출한다.  
이 패킷에는 수신처로 클라이언트의 주소가 기록되어 있기 때문이다.  
이 패킷은 스위치나 라우터를 경유하여 인터넷 속을 통해 최종적으로 클라이언트에 도착한다.