# 02. 방화벽의 원리와 동작 

### 패킷 필터링형이 주류이다

방화벽의 기본 개념은 아래와 같다
> 특정 서버와 해당 서버 안의 특정 애플리케이션에 액세스하는 패킷만 통과시키고, 그 외의 패킷을 차단한다.

네트워크에는 다양한 종류의 패킷이 많이 흐른다.  
따라서 통과시킬 패킷과 차단할 패킷을 선별하는 것은 간단한 일이 아니기 때문에 많은 방법이 고안되었다.  
그 중, 성능, 가격, 사용 편의성 등의 이유로 지금은 패킷 필터링형이 가장 많이 보급되었다.

### 패킷 필터링의 조건 설정 개념

패킷 필터링의 조건을 설정할 때는 먼저 패킷의 흐름에 착안한다.  
그리고 수신처 IP 주소와 송신처 IP 주소에 따라 시점과 종점을 판단한다.

수신처나 송신처의 주소에 따라 패킷이 어디서, 어디로 흘러가는지를 판단하여 통과시킬 것인지, 차단할 것인지 결정하는 것이 첫걸음이다.

### 애플리케이션을 한정할 때 포트 번호를 사용한다

이것뿐이라면 인터넷과 웹 서버 사이를 흐르는 패킷은 전부 통과해서 위험한 상태가 된다.  
따라서 불필요한 것, 웹 이외의 애플리케이션의 패킷을 전부 차단하는 쪽이 좋다.

애플리케이션을 한정할 때는 TCP 헤더나 UDP 헤더에 기록되어 있는 포트 번호를 조건으로 추가한다.

### 컨트롤 비트로 접속 방향을 판단한다

이렇게 해서 애플리케이션도 지정했지만 아직 조건이 부족하다.  
웹 서버에서 인터넷측에 액세스하는 동작을 정지시킬 수 없기 때문이다.

패킷이 흐르는 방향이 아니라 액세스 방향을 판단하여 정지시켜야 하는데, TCP 헤더에 있는 컨트롤 비트를 통해 알 수 있다.  
이 값을 이용해 최초의 패킷과 두 번째 이후의 패킷을 판별할 수 있다.

최초의 패킷이 웹 서버에서 인터넷측으로 흘러갈 경우 이것을 차단하도록 설정할 수 있다.  
이것을 차단하면 상대로부터 두 번째 패킷이 돌아오는 경우가 없으므로 당연히 TCP 의 접속 동작은 실패로 끝난다.  
즉, 웹 서버가 기점이 되어 인터넷에 액세스하려고 해도 접속 동작이 실패한다는 것이다.

수신처 IP 주소, 송신처 IP 주소, 각각의 포트 번호, TCP 컨트롤 비트 등등 여러 조건으로 대상이 되는 패킷을 찾아낼 수 있다.  
이렇게 해서 허가하는 액세스 동작에서 흐르는 패킷과 그 외의 패킷을 완전히 선별할 수 있을 때까지 조건을 추가한다.  
그리고 액세스를 허가하는 패킷만 통과시키고, 그 외는 차단하도록 조건을 설정한다.

### 사내 LAN 에서 공개 서버용 LAN 으로 조건을 설정한다

인터넷과 공개 서버용 LAN 을 왕래하는 패킷의 조건을 설정할 뿐만 아니라 사내 LAN 과 인터넷 또는 사내 LAN 과 공개 서버용 LAN 을 왕래하는 패킷의 조건도 설정해야 한다.  
이때 조건이 서로 악영향을 끼치지 않도록 주의해야 한다.

### 밖에서 사내 LAN 으로 액세스할 수 없다

패킷 필터링형 방화벽은 패킷을 통과시킬지, 차단시킬지를 판단할 뿐만 아니라 주소 변환의 기능도 가지고 있으므로 설정도 필요하다.  
즉, 인터넷과 사내 LAN 을 왕래하는 패킷은 주소 변환을 해야 하므로 설정이 필요하다.

주소 변환을 이용하면 인터넷측에서 사내 LAN 에는 액세스할 수 없게 된다.  
따라서 사내 LAN 에 대한 액세스를 금지하도록 패킷 필터링의 조건을 설정할 필요가 없다.

### 방화벽을 통과한다

방홥겨에는 여러 가지 조건이 설정되어 있다.  
여기에 패킷이 도착하면 조건에 해당하는지 판정하고, 통과실지와 차단할지를 결정한다.  

차단하는 패킷의 경우에는 부정 침입의 흔적을 나타내는 것이 있으므로 분석하기 위한 용도로 기록을 남긴다.

통과시킨다는 판정을 내린 경우에는 패킷을 중계하는데, 이 중계 동작은 라우터의 동작과 같다.  
일단 통과시킨다고 결정되면 그 이상의 특별한 구조는 없다.  
따라서 '패킷 필터링' 이라는 구조는 방화벽용의 특별한 구조라고 생각할 것이 아니라 라우터의 패킷 중계 기능 중에서 부가 기능이라고 생각하는 것이 좋다.

### 방화벽으로 막을 수 없는 공격

방화벽은 패킷 흐름의 시점과 종점을 보고 통과시킬지, 차단할지 판단하는데, 시점과 종점만 보고 위험한 패킷을 전부 판단할 수 있는 것은 아니다.  
패킷의 내용을 조사하지 않으면 위험한지 판단할 수 없어서 방화벽의 구조는 이러한 상황에 대처할 수 없게 된다.